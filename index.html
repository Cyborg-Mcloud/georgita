<!DOCTYPE html>
<html>
  <head>
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta http-equiv="Content-Security-Policy" content="img-src * 'self' data: https: file:; script-src 'self' 'unsafe-inline' 'unsafe-eval'; default-src *; style-src 'self' 'unsafe-inline';">
  	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Georgita</title>
<script type="text/javascript" charset="utf-8" src="cordova.js"></script>


 <link rel="stylesheet" href="leaf/leaflet.css" crossorigin=""/>
<script src="leaf/leaflet.js" crossorigin=""></script>
<script src="leaflet-tilelayer-cordova.js"></script>
  </head>
  <style>
	
	a {text-decoration:none; color:white;}
  </style>
  <body style='padding:0; border:0; margin:0; '>
  



<div id="mapid" style='border:1px solid red; width:300px; height:300px;'></div>


<!-- aq icereba ramdeni moqacha, shegizlia display:none uqna -->
<div id="status_block1"></div>
<div id="status_block2"></div>
<div id="status_block3"></div>
<div id="status_block4"></div>




<script>

var myfolder="";

function create_tiles_folder()
	{
	window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fileSystem){
		fileSystem.root.getDirectory("tiles", {create: true, exclusive: false}, fileExists, fileDoesNotExist);
		console.log(fileSystem);} , getFSFail); 
	}


function getFSFail(evt)
	{
    console.log("shit error");
    console.log(evt);
	}

function fileExists(fileEntry)
	{
	console.log(fileEntry);
	if (myfolder=="")
		{
		myfolder=fileEntry.toURL();
		}
	console.log(myfolder);
	}

function fileDoesNotExist()
	{
	console.log("ar arsebobda");
	}

var BASE;
var status_block=document.getElementById("status_block1");
var status_block2=document.getElementById("status_block2");
var status_block3=document.getElementById("status_block3");
var status_block4=document.getElementById("status_block4");
	
function onDeviceReady() 
	{
	// tiles folderis sheqmna
	create_tiles_folder();

	// rukis gamozaxeba chveulebrivad
	var mymap = L.map('mapid').setView([42.0486135,43.6605732], 14);

	// am online/offline layer-is chakereba
	BASE = L.tileLayerCordova('https://mts1.google.com/vt/hl=en&s=ge&lyrs=m&x={x}&y={y}&z={z}', {
        maxZoom: 18,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright/">OpenStreetMap contributors</a>',
        folder: 'tiles',
        name:   'tiles',
        debug:   true
    }).addTo(mymap);

	//zaderjka asinqronulobsi gamo, sheamcire tu ginda, mgoni 500-ic eyofa
	setTimeout("downtiles()",1000);

}


document.addEventListener("deviceready", onDeviceReady, false);


function offlineze()
	{
	// romeli ruka chairtos, offline tu online, aseve xdeba gadartva/garmortva shua mushaobisasac

	BASE.goOffline();
//	BASE.goOnline();
	}


//43.0182198,40.6094804


function downtiles()
	{
	
	// ---------------------------------------------- LAT , LONG , START-ZOOM, END ZOOM, piramidas agebs sastarto certilidan da ugrmavdeba qvemot, 
	//amito rac ufro zeda zooms aigeb jobia, cipa 7-8-9
//	var tile_list = BASE.calculateXYZListFromPyramid(42.0486135, 43.6605732, 7, 14);
	var tile_list = BASE.calculateXYZListFromBounds_cyborg(43.5563062, 40.1139251,42.0134336,43.6181009, 14, 14);
	BASE.downloadXYZList(tile_list, true,
      
        function (done,total) {
            var percent = Math.round(100 * done / total);
            status_block.innerHTML = done  + " / " + total + " = " + percent + "%";
        },
     
        function () {
   
            BASE.getDiskUsage(function (filecount,bytes) {
                var kilobytes = Math.round( bytes / 1024 );
                status_block.innerHTML = "Done" + "<br/>" + filecount + " files" + "<br/>" + kilobytes + " kB";
            });
        },
        function (error) {
            alert("Failed\nError code: " + error.code);
        }
    );


	var tile_list = BASE.calculateXYZListFromBounds_cyborg(42.0134336, 43.6181009,41.103544,46.6457899, 14, 14);
	BASE.downloadXYZList(tile_list, true,
      
        function (done,total) {
            var percent = Math.round(100 * done / total);
            status_block2.innerHTML = done  + " / " + total + " = " + percent + "%";
        },
     
        function () {
   
            BASE.getDiskUsage(function (filecount,bytes) {
                var kilobytes = Math.round( bytes / 1024 );
                status_block2.innerHTML = "Done" + "<br/>" + filecount + " files" + "<br/>" + kilobytes + " kB";
            });
        },
        function (error) {
            alert("Failed\nError code: " + error.code);
        }
    );

	offlineze();
	}
</script>

</body>



</html>
